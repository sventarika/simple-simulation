stages:
    - lint
    - test
    - package
    - deploy

lint:
    stage: lint
    image: ubuntu:24.04
    before_script:
        - apt-get update && apt-get install -y curl build-essential clang
        - curl -LsSf https://astral.sh/uv/install.sh | sh
        - source $HOME/.local/bin/env
        - uv sync --all-extras --dev
    script:
        - uv run ruff check --output-format=gitlab --output-file=codequality.json || uv run ruff check --output-format=concise --output-file=codequality.txt || uv run ruff check --output-format=concise
    artifacts:
        paths:
        - public
        - codequality.*
        reports:
            codequality: codequality.json
        when: always
        expire_in: '30 days'

test:
    stage: test
    image: ubuntu:24.04
    before_script:
        - apt-get update && apt-get install -y curl build-essential clang
        - curl -LsSf https://astral.sh/uv/install.sh | sh
        - source $HOME/.local/bin/env
        - uv sync --dev
        - apt-get update && apt-get install -y build-essential cmake git python3-dev python3-numpy libavcodec-dev libavformat-dev libswscale-dev libgstreamer-plugins-base1.0-dev libgstreamer1.0-dev libgtk-3-dev libpng-dev libjpeg-dev libopenexr-dev libtiff-dev libwebp-dev libopencv-dev x264 libx264-dev libssl-dev ffmpeg  # install all opencv dependencies
    script:
        - uv run pytest --junitxml=report.xml --cov=simple_simulation --cov-report=xml --cov-report=html --cov-report=term-missing test
        - uv run pycobertura show --format html --output coverage_cobertura.html coverage.xml
    artifacts:
        when: always
        expire_in: "30 days"
        reports:
            junit: report.xml
            coverage_report:
                coverage_format: cobertura
                path: coverage.xml
        paths:
            - coverage.xml
            - htmlcov
            - coverage_cobertura.html

package:
    stage: package
    image: ubuntu:24.04
    only:
        - tags
    before_script:
        - apt-get update && apt-get install -y curl build-essential clang
        - curl -LsSf https://astral.sh/uv/install.sh | sh
        - source $HOME/.local/bin/env
        - uv sync --all-extras --group=build
    script:
        - uv run -m build
        - TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token uv run -m twine upload --verbose --repository-url ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi dist/*
    rules:

deploy:
    #Build the docker container and push to registry
    stage: deploy
    image: docker:28.5.2-cli
    services:
      - name: docker:28.5.2-dind
    script:
        - docker build -t $CI_REGISTRY_IMAGE:latest .
        - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
        - docker push $CI_REGISTRY_IMAGE:latest
    rules:
        - if: '$CI_COMMIT_BRANCH == "main"'